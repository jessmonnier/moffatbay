<!--
CSD-460 Capstone Blue Team
Moffat Bay Lodge Project
Vee Bell, Deja Faison, Julia Gonzalez, Jess Monnier
Professor Sue Sampson
Developed October thru December of 2025
-->

{% extends 'pages/base.html' %}

{% block title %}Reservation Summary | Moffat Bay Lodge{% endblock %}

{% block content %}

<div style="max-width: 700px; margin: 0 auto; padding: 20px; border: 1px solid #ccc;
            border-radius: 8px; background-color: #fafafa;">
  
  {% if error %}
    <div class="error-message">
      {{ error }}
    </div>
  {% endif %}

  {% if messages %}
      {% for message in messages %}
          <div class="{{ message.tags }}-message">{{ message }}</div>
      {% endfor %}
  {% endif %}
  {% if secondary_email_status %}
    <div class="success-message">
      {{ secondary_email_status }}
    </div>
  {% endif %}

  {% if secondary_email_error %}
    <div class="error-message">
      {{ secondary_email_error }}
    </div>
  {% endif %}

  {# Invalid email warnings #}
  {% if invalid_emails %}
    <div style="border: 1px solid #b00020; background-color: #ffe5e8;
                padding: 10px 15px; margin-bottom: 20px; color: #7a0014;">
      <strong>The following email address(es) were not valid and did not receive a confirmation:</strong>
      <ul style="margin: 5px 0 0 18px;">
        {% for e in invalid_emails %}
          <li>{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <h2 style="margin-top: 0;">Reservation Summary</h2>
{% if reservation.status == 'Cancelled' %}
<p class="error-message">This reservation has either been cancelled or was on hold but expired.</p>
{% else %}
<button onclick="window.print()" class="print-btn">
    Print Reservation
</button>

<p>
  Thank you,
  {{ reservation.guest_first_name }}
  {{ reservation.guest_last_name }}.
  Please review your reservation details below:
</p>
{% endif %}

  <hr />
    
  <section style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 4px;">Reservation Number</h3>
     <p><strong>{{ reservation.public_id }}</strong></p>
  </section>

  <section style="margin-bottom: 16px;">
  <h3 style="margin-bottom: 4px;">Guest Information</h3>
  <ul style="list-style: none; padding-left: 0;">
    <li><strong>Name:</strong> {{ reservation.guest_first_name }} {{ reservation.guest_last_name }}</li>
    <li><strong>Email:</strong> {{ reservation.guest_email }}</li>
    <li><strong>Phone:</strong> {{ reservation.guest_phone }}</li>
  </ul>
  </section>

  <section style="margin-bottom: 16px;">
  <h3 style="margin-bottom: 4px;">Stay Details</h3>
  <ul style="list-style: none; padding-left: 0;">
    <li><strong>Check-in:</strong> {{ reservation.start_date }}</li>
    <li><strong>Check-out:</strong> {{ reservation.end_date }}</li>
    <li><strong>Number of Guests:</strong> {{ reservation.guests }}</li>
    <li><strong>Room Type:</strong> {{ reservation.room_type.name }}</li>
  </ul>
  </section>

  <section style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 4px;">Pricing Details</h3>

    {% if price_per_night is not None %}
      <ul style="list-style: none; padding-left: 0;">
        <li><strong>Price per night:</strong> ${{ price_per_night|floatformat:2 }}</li>
        {% if nights %}
          <li><strong>Nights:</strong> {{ nights }}</li>
        {% endif %}
        {% if total_cost %}
          <li style="margin-top: 6px;">
            <strong>Total Cost:</strong>
            <span style="font-size: 1.1rem;">${{ total_cost|floatformat:2 }}</span>
          </li>
        {% endif %}
      </ul>
    {% else %}
      <p style="color: red;">Rate information not found for this room type.</p>
    {% endif %}
  </section>

  {% if special_requests %}
    <section style="margin-bottom: 16px;">
      <h3 style="margin-bottom: 4px;">Special Requests</h3>
      <p style="white-space: pre-line;">{{ special_requests }}</p>
    </section>
  {% endif %}
{% if reservation.status != 'Cancelled' %}
  <hr>

<h3>Send Confirmation to Another Email</h3>

<form action="{% url 'send_secondary_email' %}" method="post" style="margin-top: 10px;">
    {% csrf_token %}
    <input type="hidden" name="reservation_id" value="{{ reservation.public_id }}">

    <label for="secondary_email"><strong>Additional Email:</strong></label>
    <input type="email" id="secondary_email" name="secondary_email" required>
    <button type="submit">Send Email</button>
</form>
{% endif %}


{% if reservation.status == "Cancelled" or reservation.status == "Hold" %}
  {% if reservation.expiration_time and reservation.start_datetime > now and reservation.expiration_time < now %}
<hr>
  <!-- Hold is expired -->
      <div style="margin: 15px 0; padding: 10px; background: #fff3cd; border: 1px solid #ffeeba;">
        <strong>This reservation hold has expired.</strong>
      </div>

      <form method="post" action="{% url 'retry_hold_availability' reservation.public_id %}">
        {% csrf_token %}
        <button type="submit">Check Availability Again</button>
      </form>
  {% endif %}
{% endif %}
{% if reservation.status == "Hold" and reservation.expiration_time and reservation.expiration_time >= now %}
<hr>      
  <!-- Hold is still active -->
  <form method="post" action="{% url 'confirm_hold_reservation' reservation.public_id %}">
    {% csrf_token %}
    <button type="submit" style="background: #28a745; color: white;">Confirm Reservation</button>
  </form>

  <form method="post" action="{% url 'cancel_reservation' reservation.public_id %}" style="margin-top: 10px;">
    {% csrf_token %}
    <button type="submit" style="background: #b00020; color: white;">Cancel Reservation</button>
  </form>
{% endif %}
{% if reservation.status == "Confirmed" %}
<hr>
  {% if can_modify %}
    <form method="get" action="{% url 'reservation_modify' reservation.public_id %}">
      <button type="submit">Modify Reservation</button>
    </form>

    <form method="post" action="{% url 'cancel_reservation' reservation.public_id %}" style="margin-top: 10px;">
      {% csrf_token %}
      <button type="submit" style="background: #b00020; color: white;">Cancel Reservation</button>
    </form>
  {% else %}
    <p style="color: #555; font-style: italic;">
      This reservation cannot be modified or cancelled because it is cancelled or has already started.
    </p>
  {% endif %}
{% endif %}

<hr>

  <div style="display: flex; gap: 10px; margin-top: 10px;">

    <a href="{% url 'index' %}" style="align-self: center; text-decoration: none;">
      Back to Home
    </a>
  </div>
{% if reservation.status != 'Cancelled' %}
  <p style="margin-top: 15px; font-size: 0.9rem; color: #555;">
    If everything looks correct, your reservation has been recorded. You should
    also receive a confirmation email at the address(es) you provided.
  </p>
{% endif %}
</div>


{% endblock %}
